# AI Tides Pipeline - GitHub Actions Workflow
# æ¯å¤©è‡ªåŠ¨è¿è¡Œ AI æƒ…æŠ¥èšåˆ

name: AI Tides Daily Pipeline

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´ 07:00 (UTC 23:00)
  schedule:
    - cron: '0 23 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug:
        description: 'å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'pipeline/requirements.txt'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r pipeline/requirements.txt

      # 3.5 å®‰è£… Playwright æµè§ˆå™¨ï¼ˆç”¨äºæ¯æ—¥ç®€æŠ¥é•¿å›¾æˆªå›¾ï¼‰
      - name: ğŸ¨ Install Playwright Browsers
        run: playwright install chromium --with-deps

      # 4. åˆ›å»ºè¾“å‡ºç›®å½•
      - name: ğŸ“ Create Output Directory
        run: mkdir -p pipeline/output public/briefings

      # 5. è¿è¡Œ Pipeline
      - name: ğŸŒŠ Run AI Tides Pipeline
        if: ${{ env.DASHSCOPE_API_KEY != '' }}
        run: python -m pipeline.main

      - name: Skip pipeline (missing key)
        if: ${{ env.DASHSCOPE_API_KEY == '' }}
        run: echo "DASHSCOPE_API_KEY is not set. Skipping."

      # 6. ä¸Šä¼ æŠ¥å‘Šä½œä¸º Artifact
      - name: ğŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: ai-tides-report-${{ github.run_number }}
          path: |
            pipeline/output/*.md
            pipeline/output/*.json
            pipeline/output/*.png
          retention-days: 30

      # 7. æäº¤æ›´æ–°çš„æ•°æ®æ–‡ä»¶åˆ°ä»“åº“
      - name: ğŸ“ Commit Updated Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet src/data/tide-news.json; then
            echo "No changes to commit"
          else
            git add src/data/tide-news.json
            git add pipeline/output/
            git add public/briefings/ || true
            git commit -m "ğŸŒŠ Daily AI Tides Update - $(date +'%Y-%m-%d')"
            git push
          fi

      # 8. å‘é€é€šçŸ¥ (å¯é€‰ - å¤±è´¥æ—¶)
      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "Pipeline failed! Check the logs for details."
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  Slack/Discord/Email é€šçŸ¥

  # å¯é€‰: éƒ¨ç½²åˆ° GitHub Pages
  deploy-pages:
    needs: run-pipeline
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: ğŸ”„ Pull Latest Changes
        run: git pull origin main

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
